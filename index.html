<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gluten Pro Shop</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #0f0f0f;
            color: white;
            margin: 0;
            padding: 16px;
            padding-bottom: 80px; /* –û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É, —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª—Å—è –∫–Ω–æ–ø–∫–æ–π */
            -webkit-tap-highlight-color: transparent;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        /* –§–û–ù –° –õ–û–ì–û–¢–ò–ü–û–ú */
        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            
            /* üëáüëáüëá –í–°–¢–ê–í–¨ –°–í–û–Æ –†–ê–ë–û–ß–£–Æ –°–°–´–õ–ö–£ –ù–ê –õ–û–ì–û –ù–ò–ñ–ï üëáüëáüëá */
            background-image: url('https://supabase.apexstack.ru/storage/v1/object/public/shop/Logo.png');
            
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
            /* –ò–Ω–≤–µ—Ä—Å–∏—è —Ü–≤–µ—Ç–∞ –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã + –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å */
            filter: invert(1) opacity(0.15); 
            z-index: -1;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 20px;
            font-weight: 800;
            display: flex; align-items: center; gap: 10px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .card {
            position: relative;
            height: 240px; /* –ß—É—Ç—å –≤—ã—à–µ, —á—Ç–æ–±—ã –≤–ª–µ–∑ —Å—á–µ—Ç—á–∏–∫ */
            border-radius: 16px;
            overflow: hidden;
            background-color: rgba(34, 34, 34, 0.9);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
        }

        .card-image {
            width: 100%; height: 120px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏ */
            object-fit: cover;
            background-color: #333;
        }

        .card-content {
            padding: 10px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .card-title {
            font-size: 13px; font-weight: 600; line-height: 1.3;
            margin-bottom: 8px;
            height: 34px; /* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã –∑–∞–≥–æ–ª–æ–≤–∫–∞ (2 —Å—Ç—Ä–æ–∫–∏) */
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .card-footer {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: auto;
        }

        .card-price {
            font-size: 15px; font-weight: 700; color: #ffda6b;
        }

        /* --- –ö–ù–û–ü–ö–ò –°–ß–ï–¢–ß–ò–ö–ê --- */
        .counter-controls {
            display: flex;
            align-items: center;
            background: #444;
            border-radius: 20px;
            padding: 2px;
        }

        .btn-control {
            width: 28px; height: 28px;
            border-radius: 50%;
            border: none;
            font-size: 16px; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            transition: 0.1s;
        }

        .btn-minus {
            background-color: transparent;
            color: #ffda6b;
        }
        
        .btn-plus {
            background-color: #ffda6b;
            color: black;
        }

        .btn-control:active { transform: scale(0.9); }

        .count-display {
            width: 20px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            margin: 0 2px;
        }

        /* –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –º–∏–Ω—É—Å –∏ —Ü–∏—Ñ—Ä—É, –µ—Å–ª–∏ —Ç–æ–≤–∞—Ä–∞ 0 */
        .hidden { display: none; }

        .loader {
            text-align: center; margin-top: 50px; color: #888; grid-column: span 2;
        }
        
        .error-msg {
            color: #ff6b6b; text-align: center; grid-column: span 2;
            background: rgba(50,0,0,0.5); padding: 10px; border-radius: 8px;
        }
    </style>
</head>
<body>

    <h1>–ú–µ–Ω—é <span style="font-size: 20px;">ü•ü</span></h1>
    
    <div class="grid" id="products-container">
        <div class="loader">–ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∫—É—Å–Ω–æ—Å—Ç–∏...</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // –°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–≤–æ–π n8n
        const API_URL = 'https://n8n.apexstack.ru/webhook/products'; 

        // –ö–æ—Ä–∑–∏–Ω–∞: —Ö—Ä–∞–Ω–∏–º —Ç—É—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã
        // Format: { "–í–∞—Ä–µ–Ω–∏–∫–∏ —Å –≤–∏—à–Ω–µ–π": { count: 2, price: 500 } }
        let cart = {};

        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ì–ª–∞–≤–Ω—É—é –ö–Ω–æ–ø–∫—É (—Ç–∞ —á—Ç–æ –≤–Ω–∏–∑—É)
        tg.MainButton.textColor = "#FFFFFF";
        tg.MainButton.color = "#2cab37"; // –ó–µ–ª–µ–Ω—ã–π —Ü–≤–µ—Ç –∫–Ω–æ–ø–∫–∏

        async function loadProducts() {
            try {
                const response = await fetch(API_URL);
                const result = await response.json();
                
                let products;
                if (Array.isArray(result)) {
                    products = result;
                } else {
                    products = result.data;
                }

                const container = document.getElementById('products-container');
                container.innerHTML = ''; 

                if (!products || products.length === 0) {
                    container.innerHTML = '<div class="error-msg">–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –ø—É—Å—Ç.<br>–ü—Ä–æ–≤–µ—Ä—å —Ç–∞–±–ª–∏—Ü—É Supabase</div>';
                    return;
                }

                products.forEach(product => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    
                    const imageSrc = product.image_url && product.image_url !== "EMPTY" ? product.image_url : 'https://via.placeholder.com/300x400?text=No+Image';
                    const title = product.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
                    const price = product.price;

                    // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∫–∞—Ä—Ç–æ—á–∫–∏
                    const id = product.id || Math.random().toString(36).substr(2, 9);

                    card.innerHTML = `
                        <img src="${imageSrc}" class="card-image" alt="${title}">
                        <div class="card-content">
                            <div class="card-title">${title}</div>
                            <div class="card-footer">
                                <span class="card-price" id="price-${id}">${price} ‚ÇΩ</span>
                                
                                <div class="counter-controls">
                                    <button class="btn-control btn-minus hidden" id="minus-${id}" onclick="updateCart('${id}', '${title}', ${price}, -1)">‚àí</button>
                                    <span class="count-display hidden" id="count-${id}">0</span>
                                    <button class="btn-control btn-plus" onclick="updateCart('${id}', '${title}', ${price}, 1)">+</button>
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                document.getElementById('products-container').innerHTML = `
                    <div class="error-msg">
                        <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>
                        <p style="font-size: 12px; opacity: 0.8;">${error.message}</p>
                    </div>`;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ—Ä–∑–∏–Ω—ã
        function updateCart(id, title, price, change) {
            // –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä–∞ –µ—â–µ –Ω–µ—Ç –≤ –∫–æ—Ä–∑–∏–Ω–µ, —Å–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å
            if (!cart[id]) {
                cart[id] = { title: title, price: price, count: 0 };
            }

            // –ú–µ–Ω—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
            cart[id].count += change;

            // –ï—Å–ª–∏ —Å—Ç–∞–ª–æ –º–µ–Ω—å—à–µ 0, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º 0
            if (cart[id].count < 0) cart[id].count = 0;

            // --- –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫–∞—Ä—Ç–æ—á–∫–∏ ---
            const countEl = document.getElementById(`count-${id}`);
            const minusBtn = document.getElementById(`minus-${id}`);
            const priceEl = document.getElementById(`price-${id}`);

            countEl.innerText = cart[id].count;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –º–∏–Ω—É—Å –∏ —Å—á–µ—Ç—á–∏–∫
            if (cart[id].count > 0) {
                countEl.classList.remove('hidden');
                minusBtn.classList.remove('hidden');
                // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Ü–µ–Ω–∞ (–¶–µ–Ω–∞ –∑–∞ —à—Ç * –∫–æ–ª-–≤–æ)
                priceEl.innerText = (price * cart[id].count) + " ‚ÇΩ";
                priceEl.style.color = "#ffffff"; // –ë–µ–ª—ã–π —Ü–≤–µ—Ç, –∫–æ–≥–¥–∞ –≤—ã–±—Ä–∞–Ω–æ
            } else {
                countEl.classList.add('hidden');
                minusBtn.classList.add('hidden');
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ü–µ–Ω—É –∑–∞ 1 —à—Ç
                priceEl.innerText = price + " ‚ÇΩ"; 
                priceEl.style.color = "#ffda6b"; // –ó–æ–ª–æ—Ç–æ–π —Ü–≤–µ—Ç (–∏—Å—Ö–æ–¥–Ω—ã–π)
                delete cart[id]; // –£–¥–∞–ª—è–µ–º –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã, –µ—Å–ª–∏ 0
            }

            tg.HapticFeedback.impactOccurred('light'); // –í–∏–±—Ä–∞—Ü–∏—è
            updateMainButton(); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤–Ω–∏–∑—É
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ì–ª–∞–≤–Ω–æ–π –ö–Ω–æ–ø–∫–∏
        function updateMainButton() {
            let totalSum = 0;
            let totalItems = 0;

            for (let key in cart) {
                const item = cart[key];
                if (item.count > 0) {
                    totalSum += item.price * item.count;
                    totalItems += item.count;
                }
            }

            if (totalItems > 0) {
                tg.MainButton.setText(`–ó–∞–∫–∞–∑–∞—Ç—å –Ω–∞ ${totalSum} ‚ÇΩ`);
                tg.MainButton.show();
            } else {
                tg.MainButton.hide();
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –ì–ª–∞–≤–Ω—É—é –ö–Ω–æ–ø–∫—É
        tg.MainButton.onClick(function() {
            // –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –æ–±—ä–µ–∫—Ç –∫–æ—Ä–∑–∏–Ω—ã –≤ –∫—Ä–∞—Å–∏–≤—ã–π —Å–ø–∏—Å–æ–∫ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            const orderData = {
                items: [],
                total_price: 0
            };

            for (let key in cart) {
                if (cart[key].count > 0) {
                    orderData.items.push({
                        title: cart[key].title,
                        count: cart[key].count,
                        price: cart[key].price,
                        sum: cart[key].price * cart[key].count
                    });
                    orderData.total_price += cart[key].price * cart[key].count;
                }
            }

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É (–≤ n8n –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –≤ —á–∞—Ç)
            tg.sendData(JSON.stringify(orderData));
        });

        loadProducts();
    </script>
</body>
</html>
